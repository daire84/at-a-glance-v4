{% extends "base.html" %}

{% block title %}Edit Day - {{ day.date }} - Schedule, At a Glance!{% endblock %}

{% block styles %}
<link rel="stylesheet" href="/static/css/forms.css">
<link rel="stylesheet" href="/static/css/calendar.css">
<style>
  /* Additional styles for the department tag selection */
  .department-tag-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
  
  .department-tag-option {
    display: inline-block;
    padding: 0.4rem 0.7rem;
    border-radius: 3px;
    font-size: 0.8rem;
    cursor: pointer;
    user-select: none;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .department-tag-option.selected {
    outline: 2px solid var(--accent-color);
  }
  
  .selected-departments {
    margin-top: 0.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <h2>
        {% if day.isPrep %}
            Edit Prep Day
        {% else %}
            Edit Shoot Day {{ day.shootDay if day.shootDay }}
        {% endif %}
    </h2>
    <div class="admin-actions">
        <a href="/admin/calendar/{{ project.id }}" class="button secondary">Back to Calendar</a>
    </div>
</div>

<div class="form-container">
    <div class="day-header">
        <h3>{{ day.dayOfWeek }}, {{ day.date }}</h3>
    </div>
    
    <form method="POST" class="day-form" id="day-form">
        <!-- Hidden field to store department tags -->
        <input type="hidden" id="departments-input" name="departments" value="{{ day.departments|join(',') if day.departments else '' }}">
        
        <div class="form-section">
            <h3>Main Unit Details</h3>
            
            <div class="form-row">
                <div class="form-group full-width">
                    <label for="mainUnit">Main Unit Description</label>
                    <input type="text" id="mainUnit" name="mainUnit" value="{{ day.mainUnit or '' }}" placeholder="E.g., JOHN'S HOUSE - KITCHEN">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="location">Location</label>
                    <select id="location" name="location" class="location-select">
                        <option value="">-- Select Location --</option>
                        <!-- Locations will be populated via AJAX -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="locationArea">Location Area</label>
                    <select id="locationArea" name="locationArea">
                        <option value="">-- Select Area --</option>
                        <!-- Areas will be populated via AJAX -->
                    </select>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Extras</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="extras">Background Extras</label>
                    <input type="number" id="extras" name="extras" value="{{ day.extras or 0 }}" min="0">
                </div>
                
                <div class="form-group">
                    <label for="featuredExtras">Featured Extras</label>
                    <input type="number" id="featuredExtras" name="featuredExtras" value="{{ day.featuredExtras or 0 }}" min="0">
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Script Information</h3>
            
            <div class="form-row">
                <div class="form-group full-width">
                    <label for="sequence">Sequence</label>
                    <input type="text" id="sequence" name="sequence" value="{{ day.sequence or '' }}" placeholder="Scene/Sequence numbers">
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Department Requirements</h3>
            
            <div class="form-row">
                <div class="form-group full-width">
                    <label>Select Department Tags</label>
                    <div class="department-tag-selector" id="department-selector">
                        <!-- Department tags will be populated via AJAX -->
                    </div>
                    
                    <div class="selected-departments">
                        <label>Selected Departments:</label>
                        <div id="selected-departments-display">
                            {% for dept in day.departments %}
                            <span class="department-tag">{{ dept }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Notes</h3>
            
            <div class="form-row">
                <div class="form-group full-width">
                    <label for="notes">Day Notes</label>
                    <textarea id="notes" name="notes" rows="3">{{ day.notes or '' }}</textarea>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Second Unit (if applicable)</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="secondUnit">Second Unit Description</label>
                    <input type="text" id="secondUnit" name="secondUnit" value="{{ day.secondUnit or '' }}" placeholder="Second unit activity">
                </div>
                
                <div class="form-group">
                    <label for="secondUnitLocation">Second Unit Location</label>
                    <input type="text" id="secondUnitLocation" name="secondUnitLocation" value="{{ day.secondUnitLocation or '' }}" placeholder="Second unit location">
                </div>
            </div>
        </div>
        
        <div class="form-actions">
            <a href="/admin/calendar/{{ project.id }}" class="button secondary">Cancel</a>
            <button type="submit" class="button">Save Changes</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load locations
    fetchLocations();
    
    // Load areas
    fetchAreas();
    
    // Load departments
    fetchDepartments();
    
    // Handle form submission
    const dayForm = document.getElementById('day-form');
    if (dayForm) {
        dayForm.addEventListener('submit', function(e) {
            // Make sure departments are correctly set before submitting
            updateDepartmentsInput();
        });
    }
    
    // Function to fetch locations from API
    function fetchLocations() {
        fetch('/api/locations')
            .then(response => response.json())
            .then(locations => {
                populateLocationDropdown(locations);
            })
            .catch(error => {
                console.error('Error fetching locations:', error);
            });
    }
    
    // Function to fetch areas from API
    function fetchAreas() {
        fetch('/api/areas')
            .then(response => response.json())
            .then(areas => {
                populateAreaDropdown(areas);
            })
            .catch(error => {
                console.error('Error fetching areas:', error);
            });
    }
    
    // Function to fetch departments from API
    function fetchDepartments() {
        fetch('/api/departments')
            .then(response => response.json())
            .then(departments => {
                populateDepartmentSelector(departments);
            })
            .catch(error => {
                console.error('Error fetching departments:', error);
            });
    }
    
    // Function to populate location dropdown
    function populateLocationDropdown(locations) {
        const locationSelect = document.getElementById('location');
        if (!locationSelect) return;
        
        // Get current value
        const currentValue = locationSelect.value;
        
        // Clear existing options except first one
        const firstOption = locationSelect.options[0];
        locationSelect.innerHTML = '';
        locationSelect.appendChild(firstOption);
        
        // Add location options
        locations.forEach(location => {
            const option = document.createElement('option');
            option.value = location.name;
            option.textContent = location.name;
            locationSelect.appendChild(option);
        });
        
        // Restore current value if it exists
        if (currentValue) {
            locationSelect.value = currentValue;
        } else {
            // Set to value from day if available
            const dayLocation = '{{ day.location }}';
            if (dayLocation) {
                for (let i = 0; i < locationSelect.options.length; i++) {
                    if (locationSelect.options[i].value === dayLocation) {
                        locationSelect.selectedIndex = i;
                        break;
                    }
                }
            }
        }
        
        // Add event listener to update location area when location changes
        locationSelect.addEventListener('change', function() {
            const selectedLocation = this.value;
            const locationObj = locations.find(loc => loc.name === selectedLocation);
            
            if (locationObj && locationObj.areaId) {
                const areaSelect = document.getElementById('locationArea');
                if (areaSelect) {
                    for (let i = 0; i < areaSelect.options.length; i++) {
                        if (areaSelect.options[i].value === locationObj.areaId) {
                            areaSelect.selectedIndex = i;
                            break;
                        }
                    }
                }
            }
        });
    }
    
    // Function to populate area dropdown
    function populateAreaDropdown(areas) {
        const areaSelect = document.getElementById('locationArea');
        if (!areaSelect) return;
        
        // Get current value
        const currentValue = areaSelect.value;
        
        // Clear existing options except first one
        const firstOption = areaSelect.options[0];
        areaSelect.innerHTML = '';
        areaSelect.appendChild(firstOption);
        
        // Add area options
        areas.forEach(area => {
            const option = document.createElement('option');
            option.value = area.name;
            option.textContent = area.name;
            // Add data attribute for color
            option.setAttribute('data-color', area.color);
            areaSelect.appendChild(option);
        });
        
        // Restore current value if it exists
        if (currentValue) {
            areaSelect.value = currentValue;
        } else {
            // Set to value from day if available
            const dayArea = '{{ day.locationArea }}';
            if (dayArea) {
                for (let i = 0; i < areaSelect.options.length; i++) {
                    if (areaSelect.options[i].value === dayArea) {
                        areaSelect.selectedIndex = i;
                        break;
                    }
                }
            }
        }
        
        // Add color indicators to area options
        addColorIndicatorsToSelect(areaSelect);
    }
    
    // Function to add color indicators to select options
    function addColorIndicatorsToSelect(selectElement) {
        const options = selectElement.querySelectorAll('option');
        
        options.forEach(option => {
            if (option.getAttribute('data-color')) {
                const color = option.getAttribute('data-color');
                option.style.backgroundColor = color;
                
                // Set text color based on background brightness
                const rgb = hexToRgb(color);
                if (rgb) {
                    const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
                    option.style.color = brightness > 128 ? '#000000' : '#ffffff';
                }
            }
        });
    }
    
    // Function to populate department selector
    function populateDepartmentSelector(departments) {
        const departmentSelector = document.getElementById('department-selector');
        if (!departmentSelector) return;
        
        // Clear existing department tags
        departmentSelector.innerHTML = '';
        
        // Get currently selected departments
        const selectedDepts = '{{ day.departments|join(",") if day.departments else "" }}'.split(',').filter(Boolean);
        
        // Add department options
        departments.forEach(dept => {
            const deptTag = document.createElement('div');
            deptTag.className = 'department-tag-option';
            if (selectedDepts.includes(dept.code)) {
                deptTag.classList.add('selected');
            }
            
            deptTag.textContent = dept.code;
            deptTag.style.backgroundColor = dept.color;
            
            // Set text color based on background brightness
            const rgb = hexToRgb(dept.color);
            if (rgb) {
                const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
                deptTag.style.color = brightness > 128 ? '#000000' : '#ffffff';
            }
            
            // Set data attribute for department code
            deptTag.setAttribute('data-code', dept.code);
            
            // Add click handler
            deptTag.addEventListener('click', function() {
                this.classList.toggle('selected');
                updateSelectedDepartmentsDisplay();
                updateDepartmentsInput();
            });
            
            departmentSelector.appendChild(deptTag);
        });
        
        // Initialize selected departments display
        updateSelectedDepartmentsDisplay();
    }
    
    // Function to update selected departments display
    function updateSelectedDepartmentsDisplay() {
        const selectedDepartmentsDisplay = document.getElementById('selected-departments-display');
        if (!selectedDepartmentsDisplay) return;
        
        // Clear current display
        selectedDepartmentsDisplay.innerHTML = '';
        
        // Get selected department tags
        const selectedTags = document.querySelectorAll('.department-tag-option.selected');
        
        if (selectedTags.length === 0) {
            selectedDepartmentsDisplay.textContent = 'None selected';
            return;
        }
        
        // Add each selected department to the display
        selectedTags.forEach(tag => {
            const deptCode = tag.getAttribute('data-code');
            const deptSpan = document.createElement('span');
            deptSpan.className = 'department-tag';
            deptSpan.textContent = deptCode;
            deptSpan.style.backgroundColor = tag.style.backgroundColor;
            deptSpan.style.color = tag.style.color;
            
            selectedDepartmentsDisplay.appendChild(deptSpan);
        });
    }
    
    // Function to update departments input field before form submission
    function updateDepartmentsInput() {
        const departmentsInput = document.getElementById('departments-input');
        if (!departmentsInput) return;
        
        // Get selected department tags
        const selectedTags = document.querySelectorAll('.department-tag-option.selected');
        
        // Create comma-separated list of department codes
        const deptCodes = Array.from(selectedTags).map(tag => tag.getAttribute('data-code'));
        departmentsInput.value = deptCodes.join(',');
    }
    
    // Helper function to convert hex color to RGB
    function hexToRgb(hex) {
        if (!hex) return null;
        
        // Remove # if present
        hex = hex.replace(/^#/, '');
        
        // Parse hex values
        const bigint = parseInt(hex, 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        
        return { r, g, b };
    }
});
</script>
{% endblock %}